<match blog-metricks.bookmark>
  type copy
  <store>
    # BigQueryの保存先テーブルを年毎に変化させる
    type record_reformer
    enable_ruby true
    tag ${tag}.${time.strftime('%Y')}
  </store>
</match>

<match blog-metricks.bookmark.**>
  type forest
  subtype copy
  <template>
    <store>
      type bigquery
      method insert

      auth_method json_key
      json_key /etc/td-agent/.keys/nginx-log-to-bigquery-jsonkey.json

      project a-know-home
      dataset blog_metricks

      flush_interval 1
      buffer_chunk_records_limit 1000
      buffer_queue_limit 1024
      num_threads 16

      auto_create_table true
      table bookmark_count_${tag_parts[-1]}

      time_format %s
      time_field time
      schema_path /etc/td-agent/settings/bookmark_count_schema.json
    </store>
  </template>
</match>
