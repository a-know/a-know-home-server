# LTSV形式のログファイルを読み込む
<source>
  type tail
  format ltsv
  time_format %d/%b/%Y:%H:%M:%S %z
  path /var/log/nginx/home.a-know.me.access.log
  pos_file /var/log/td-agent/home.a-know.me.access_log.pos
  tag log.nginx
</source>

<match log.nginx>
  type copy
  <store>
    # BigQueryの保存先テーブルを月毎に変化させる
    type record_reformer
    enable_ruby true
    tag ${tag}.${time.strftime('%Y%m')}
  </store>
  <store>
    # fluent-plugin-datacounterでステータスコード別に集計する
    type datacounter
    count_interval 1m
    count_key status
    aggregate all
    tag nginx.status.mackerel
    pattern1 2xx ^2\d\d$
    pattern2 3xx ^3\d\d$
    pattern3 4xx ^4\d\d$
    pattern4 5xx ^5\d\d$
  </store>
</match>

# fluent-plugin-mackerelによりサービスメトリックを投稿する
<match nginx.status.mackerel>
  type mackerel
  api_key <%= @mackerel_api_key %>
  service <%= @mackerel_service_name %>
  remove_prefix
  metrics_name access_num.${out_key}
  out_keys 2xx_count,3xx_count,4xx_count,5xx_count
</match>

<match log.nginx.**>
  type forest
  subtype copy
  <store>
    type bigquery
    method insert

    auth_method json_key
    json_key /etc/td-agent/.keys/nginx-log-to-bigquery-jsonkey.json

    project a-know-home
    dataset centrage_nginx_log

    auto_create_table true
    table access_log_${tag_parts[-1]}

    time_format %s
    time_field time
    schema_path /etc/td-agent/settings/nginx_access_log_schema.json
  </store>
</match>
