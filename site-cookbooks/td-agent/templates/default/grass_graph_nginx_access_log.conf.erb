# LTSV形式のログファイルを読み込む
<source>
  type tail
  format ltsv
  time_format %Y-%m-%d %H:%M:%S %z
  path /var/log/nginx/grass-graph.shitemil.works.access.log
  read_from_head true
  rotate_wait 60
  pos_file /var/log/td-agent/grass-graph.shitemil.works.access_log.pos
  tag gg.log.nginx
</source>

<match gg.log.nginx>
  type copy
  <store>
    # BigQueryの保存先テーブルを日毎に変化させる
    type record_reformer
    enable_ruby true
    tag ${tag}.${time.strftime('%Y%m%d')}
  </store>
  <store>
    # fluent-plugin-datacounterでステータスコード別に集計する
    type datacounter
    count_interval 1m
    count_key status
    aggregate all
    tag gg.nginx.status.mackerel
    pattern1 2xx ^2\d\d$
    pattern2 3xx ^3\d\d$
    pattern3 4xx ^4\d\d$
    pattern4 5xx ^5\d\d$
  </store>
</match>

# fluent-plugin-mackerelによりサービスメトリックを投稿する
<match gg.nginx.status.mackerel>
  type forest
  subtype copy
  <template>
    <store>
      type mackerel
      api_key <%= @mackerel_api_key_old %>
      service <%= @mackerel_service_name_old %>
      remove_prefix
      metrics_name access_num.${out_key}
      out_keys 2xx_count,3xx_count,4xx_count,5xx_count
    </store>
      <store>
        type mackerel
        api_key <%= @mackerel_api_key %>
        service <%= @mackerel_service_name %>
        remove_prefix
        metrics_name access_num.${out_key}
        out_keys 2xx_count,3xx_count,4xx_count,5xx_count
      </store>
  </template>
</match>

<match gg.log.nginx.**>
  type forest
  subtype copy
  <template>
    <store>
      type bigquery
      method insert

      auth_method json_key
      json_key /etc/td-agent/.keys/gcp-credential-for-fluentd-jsonkey.json

      project a-know-home
      dataset centrage_nginx_log

      flush_interval 1
      buffer_chunk_records_limit 1000
      buffer_queue_limit 1024
      num_threads 16

      auto_create_table true
      table gg_nginx_access_log_${tag_parts[-1]}

      time_format %s
      time_field time
      # scheme は home.a-know.me の access log と同じなので使い回す
      schema_path /etc/td-agent/settings/nginx_access_log_schema.json
    </store>
  </template>
</match>
